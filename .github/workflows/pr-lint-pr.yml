name: PR - Lint PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ci-${{ github.event.number }}
  cancel-in-progress: true

defaults:
  run:
    shell: pwsh

jobs:
  pr-lint:
    runs-on: ubuntu-latest
    name: Check linked issues
    steps:
      - uses: actions/checkout@v2
        with:
          # Checkout as many commits as needed for the diff
          fetch-depth: 2
      - shell: pwsh
        # Give an id to the step, so we can reference it later
        id: check_file_changed
        run: |
          # Diff HEAD with the previous commit
          $diff = git diff --name-only HEAD^ HEAD

          # Check if a file under docs/ or with the .md extension has changed (added, modified, deleted)
          $SourceDiff = $diff | Where-Object { $_ -notmatch '^content/' -or $_ -notmatch '^public/' -or $_ -notmatch '^.github/' }
          $HasDiff = $SourceDiff.Length -gt 0

          # Set the output named "docs_changed"
          Write-Host "::set-output name=docs_changed::$HasDiff"
          Write-Host "::set-output name=docs::$diff"
          Write-Host "::set-output name=docs_s::$SourceDiff"

      - name: For Testing
        run: echo ${{steps.check_file_changed.outputs.docs_changed}} - ${{steps.check_file_changed.outputs.docs}} - - ${{steps.check_file_changed.outputs.docs_s}}

      - uses: nearform-actions/github-action-check-linked-issues@v1.4.16
        if: ${{steps.changes.outputs.other_changes == 'true'}}
        id: check-linked-issues
        with:
          exclude-branches: "dependabot/**"

      - name: Generate summary
        run: |
          echo "Found ${{ steps.check-linked-issues.outputs.linked_issues_count }} issues linked to PR" >> $GITHUB_STEP_SUMMARY
